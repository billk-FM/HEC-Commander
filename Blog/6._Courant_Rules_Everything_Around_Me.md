# Courant Rules Everything Around Me 
## Balancing Accuracy, Resolution, and Efficiency in Large-Scale HEC-RAS Modeling 

<p align="center">
  <img src="img/CourantRulesEverythingAroundMe.png" width="500">
</p>
 
## I. Introduction

In HEC-RAS modeling, we often find ourselves grappling with complex challenges that demand innovative solutions. Just as the Wu-Tang Clan once declared that "Cash Rules Everything Around Me" in their iconic song "C.R.E.A.M.," we modelers might say that "Courant Rules Everything Around Me" The Courant number, a key factor in model stability and performance, is a critical consideration in our quest to build accurate, efficient, and scalable models.

As we tackle increasingly large-scale modeling projects, we find ourselves at a crossroads. How do we balance the need for high-resolution, accurate results with the practical constraints of computational resources and project timelines? In this blog post, we'll explore this central challenge and discuss strategies for finding the optimal balance between accuracy, resolution, and efficiency in large-scale hydraulic modeling.

## II. HEC-RAS Guidance on Grid Size and Time Step Selection

The developers of HEC-RAS have provided valuable guidance on selecting appropriate grid sizes and time steps for 2D modeling. They emphasize the importance of creating a computational mesh that accurately represents the terrain, flow paths, and hydraulic controls. HEC-RAS employs a unique approach, using detailed elevation-volume/area relationships for cells and cross-sections for faces, which allows for larger cell sizes while still capturing the essential features of the terrain.

When developing a computational mesh in HEC-RAS, modelers should focus on aligning cell faces with barriers to flow, such as levees, roads, and natural high ground. Refinement regions along channel banks can help ensure proper separation of main channel and overbank flows. Additionally, cell sizes should be selected to adequately capture changes in water surface slope and velocity.

Once a suitable mesh is created, modelers must select an appropriate computational time step based on the cell size and flow velocity. HEC-RAS provides guidelines for choosing time steps based on the equation set being used (Shallow Water or Diffusion Wave) and the desired Courant number. The Courant number is a dimensionless value that relates the computational time step, cell size, and flow velocity:
```
C = VΔT / ΔX ≤ 1.0 (with a max C = 3.0 for Shallow Water Equations and max C = 5.0 for Diffusion Wave Equations)
```

Where:
- C = Courant Number
- V = Flood wave velocity (ft/s)
- ΔT = Computational time step (s)
- ΔX = Average cell size (ft)

Importantly, modelers are advised to test the consistency of their mesh and time step by running simulations with varying resolutions and time steps to assess the impact on results and performance. This process of testing and refinement is crucial for finding the sweet spot between accuracy and efficiency, particularly in large-scale modeling projects.

## III. Challenges of Applying Guidance to Large-Scale Models

While the HEC-RAS guidance on mesh design and time step selection provides valuable insights, it's important to recognize that it presents a highly deterministic view of terrain representation that may not always be achievable at every scale. The guidance emphasizes the inclusion of all significant terrain features, which can be challenging when working with large watersheds and complex urban environments.

In addition to the HEC-RAS guidance, there are numerous prescriptive regulatory documents and other guidance materials that specify minimum resolution requirements for hydraulic models. These standards often fail to consider the scalability issues that arise when applying them to very large watersheds. For example, modeling small structures or capturing intricate urban drainage patterns may be crucial for local-scale studies but can quickly become computationally infeasible when extended to a regional or watershed scale.

Modelers are often faced with conflicting priorities when attempting to adhere to these prescriptive standards while also striving for acceptable model performance. In urban areas, there may be seemingly critical ridgelines or terrain details that a modeler would insist on including at a local scale. However, when working with large watersheds, the significance of these features must be carefully evaluated in the context of the overall modeling objectives and computational constraints.

The reality is that, due to the inherent limitations of current modeling tools, it is not always possible to achieve the level of detail specified in prescriptive standards while maintaining a highly performant model at large scales. This can put modelers in a difficult position, particularly when the standards conflict with the practical realities of the project.

The outcome of this conflict often depends on the judgment and priorities of the individual engineer in charge of the project. Some may choose to avoid the issue altogether and deliver a model that meets the letter of the standards but fails to perform adequately. While this approach may satisfy the literal requirements, it ultimately does a disservice to the project's objectives and the needs of the end-users.  To navigate these challenges effectively, it's crucial for modelers to have open and honest conversations with their clients about the tradeoffs between detail, accuracy, and performance. Establishing clear benchmarks for acceptable model performance, based on the project's specific goals and the available computational resources, can help guide decision-making and set realistic expectations.  Where feasible, standards should be less prescriptive and emphasize the required differences of scale between project or area-specific models that model local-scale hazards, and the desired level of detail vs performance considerations that must be taken into account to efficently develop models that are useful for their intended purposes. 

Furthermore, as we'll discuss in our next blog post, the rapid evolution of computing hardware can introduce additional variability and uncertainty into the modeling process. By providing transparency around performance requirements, including reference hardware specifications and benchmarking results, modelers can help ensure that their work remains relevant and valuable even as technology continues to advance.

Ultimately, the key to success in large-scale hydraulic modeling lies in finding the right balance between adherence to standards, practical feasibility, and the delivery of reliable, actionable results. By approaching these challenges with flexibility, transparency, and a commitment to open communication, modelers can navigate the limitations of prescriptive guidance and deliver models that meet the needs of their clients and the communities they serve.

## IV. Proposed Approach: Tiered Resolution and Minimum Cell Size

To address the challenges of large-scale hydraulic modeling, we propose a tiered resolution approach that balances the need for accuracy and efficiency. This strategy involves enforcing a minimum cell size throughout the model domain to manage computational demands while strategically applying finer meshes in critical areas such as channels, key hydraulic controls, and regions of complex flow patterns.

By maintaining a coarser overall resolution, modelers can significantly reduce the total number of cells in the model, leading to faster runtimes and improved stability. However, it's essential to recognize that this approach may require accepting some approximations in smaller features that cannot be fully resolved at the chosen cell size. In these cases, techniques like terrain modification or increased roughness values can be used to parameterize the effects of these features on the overall flow dynamics.

The tiered resolution approach allows modelers to allocate computational resources where they are needed most, ensuring that the key drivers of flow behavior are accurately represented while maintaining acceptable performance. This strategy requires careful consideration of the model's objectives, the spatial distribution of critical hydraulic features, and the available computational resources.

## V. Pitfalls of Over-Reliance on Adaptive Timesteps

Adaptive timesteps can be a valuable tool for improving model stability and performance, particularly in situations where flow conditions vary significantly across the model domain. By automatically adjusting the time step based on local Courant number calculations, adaptive timesteps can help maintain numerical stability while minimizing computational demands.

However, it's crucial to recognize that adaptive timesteps are not a panacea for fundamental issues with model design and mesh resolution. Over-reliance on adaptive timesteps can sometimes lead to increased model instability and usability issues, particularly if the underlying mesh is not well-suited to the flow conditions being simulated.

In some cases, modelers may find that adaptive timesteps are necessary to handle specific terrain features or flow conditions that cannot be adequately represented at the chosen cell size. However, it's generally preferable to address these issues through strategic mesh refinement or terrain modification rather than relying solely on adaptive timesteps to compensate for mesh limitations.


## VIII. Case Study: Optimization of the Amite Transition Zone HEC-RAS Model

To illustrate the effectiveness of the optimization strategies discussed in this post, let's examine a case study involving the Amite Transition Zone HEC-RAS Model, a full 2-dimensional model with various inputs and boundary conditions (Partida, 2022, private communication).

The original model had extensive simulation times exceeding 30 hours in most cases, severely limiting the number of simulations that could be executed, even on high-performance computers. To address this issue, the optimization process focused on re-evaluating mesh resolution, computational time step, and Courant conditions.

In the original model, cell sizes ranged from 1,000 ft x 1,000 ft to as low as 100 ft x 100 ft along breaklines. The optimized model adjusted the cell spacing along streams to 500 ft x 500 ft and lowered the overall mesh spacing to 800 ft x 800 ft. This change limited cell size variances and Courant conditions globally, contributing to a higher computational time step and more efficient simulations.

The original model also contained 10 independent 2D meshes connected via SA/2D Connectors, which sometimes acted as elevated weirs, disrupting the transfer of runoff between meshes. The optimized model merged these into a single mesh, eliminating the need for SA/2D Connectors and improving flow continuity.

The computational time step was another key factor in optimization. The original model used a base time step of 12 seconds with divisors, resulting in time steps as low as 1.5 seconds. The optimized model adjusted the time step to 2 minutes with no divisors, still maintaining low Courant numbers and satisfactory results when compared to USGS gauge data.

The optimization process resulted in significant improvements in simulation times:

- For Hurricane Isaac, the runtime decreased from 34 hours 42 minutes to just 1 hour 8 minutes.
- For Hurricane Gustav, the runtime decreased from 44 hours 8 minutes to only 39 minutes 57 seconds.
- For the August 2016 storm event, the runtime decreased from 30 hours 26 minutes to 35 minutes 9 seconds.
- For Hurricane Katrina, the runtime decreased from 36 hours 34 minutes to 32 minutes 32 seconds.

Statistical comparisons between the original and optimized model results showed strong performance metrics, with very good ratings for RSR, NSE, and R2, and satisfactory to very good ratings for PBIAS.

This case study demonstrates the substantial benefits of applying optimization strategies to large-scale hydraulic models. By carefully adjusting mesh resolution, computational time steps, and model structure, modelers can achieve significant improvements in runtime efficiency while maintaining acceptable levels of accuracy. These optimizations enable more extensive model runs and facilitate the use of these models in real-time forecasting systems and other applications where computational efficiency is critical.

Reference:
_Partida, L. (2022). Optimization of the Amite Transition Zone HEC-RAS Model. Private communication, The Water Institute of the Gulf._

## VII. Balancing Tradeoffs in Large-Scale Modeling

Ultimately, successful large-scale hydraulic modeling requires a delicate balance between accuracy, resolution, and computational efficiency. Modelers must work within the constraints of their available software and hardware while striving to allocate limited computational resources in a way that maximizes the value and reliability of their simulations.

This balance will look different for every project, depending on the specific objectives, data availability, and computational constraints. Modelers must think critically about these tradeoffs and make informed decisions based on a deep understanding of the problem at hand and the strengths and limitations of their modeling tools.

By embracing innovative approaches like tiered resolution meshes, strategic terrain modification, and judicious use of adaptive timesteps, modelers can navigate these tradeoffs more effectively. However, it's important to recognize that there is no one-size-fits-all solution, and the optimal approach will vary depending on the unique characteristics of each modeling project.

## VIII. Conclusion

In conclusion, balancing accuracy, resolution, and efficiency in large-scale hydraulic modeling is a complex and ongoing challenge that requires careful consideration of multiple factors. By adopting innovative strategies like tiered resolution approach with minimum mesh spacing, strategic terrain modification, and avoiding the use of adaptive timesteps as a way of avoiding mesh edits, modelers can navigate these tradeoffs more effectively and deliver reliable, accurate simulations even in the face of computational constraints. 

## Sdditional References
1. [Selecting an Appropriate Grid Size and Time Step](https://www.hec.usace.army.mil/confluence/rasdocs/r2dum/latest/developing-a-terrain-model-and-computational-mesh/selecting-an-appropriate-grid-size-and-time-step)

2. [Compound Flood Transition Zone Pilot Study for the Amite River Basin](https://thewaterinstitute.org/assets/docs/reports/Compound-Flood-Transition-Zone-Pilot-Study-for-the-Amite-River-Basin.pdf)
   
3. [An Adaptive Time-Step Optimization Method for 2D HEC-RAS Simulations](https://www.kleinschmidtgroup.com/ras-post/an-adaptive-time-step-optimization-method-for-2d-hec-ras-simulations/)
